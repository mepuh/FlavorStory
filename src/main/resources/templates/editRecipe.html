<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title th:text="#{title.editRecipe}">Edit Recipe</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="/css/site.css" th:href="@{/css/site.css}" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<!--Recipe editing page-->

<body th:attr="data-remove-text=#{button.remove}, data-add-ingredient-text=#{placeholder.addIngredient}, data-add-step-text=#{placeholder.addStep}">
    <div th:replace="fragments :: header"></div>
    <main class="container my-5">
        <div class="main-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0" th:text="#{title.editRecipe}">Edit Recipe</h2>
                <div>
                    <a class="btn btn-outline-secondary me-2" th:href="@{/recipes}" th:text="#{button.backToRecipes}">Back to Recipes</a>
                </div>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
            <form th:action="@{/recipes/{id}/edit(id=${recipe.recipeId})}" method="post" th:attr="data-confirm=#{confirm.saveRecipe}"
                onsubmit="return confirm(this.dataset.confirm);">
                <div class="mb-3">
                    <label for="title" class="form-label" th:text="#{label.title}">Title</label>
                    <input type="text" id="title" name="title" th:value="${recipe.title}" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label" th:text="#{label.shortDescription}">Description</label>
                    <textarea id="description" name="description" class="form-control" rows="3" required
                        th:text="${recipe.description}"></textarea>
                </div>
                <div class="mb-3">
                    <label for="preparationTime" class="form-label" th:text="#{label.preparationTime}">Preparation Time</label>
                    <input type="text" id="preparationTime" name="preparationTime" th:value="${recipe.preparationTime}"
                        class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" th:text="#{label.ingredients}">Ingredients</label>
                    <div id="ingredientsContainer">
                        <div th:if="${#lists.isEmpty(recipe.ingredients)}" class="input-group mb-2">
                            <textarea name="ingredients" class="form-control" rows="2"
                                th:placeholder="#{placeholder.addIngredient}"></textarea>
                            <button type="button" class="btn btn-outline-danger ms-2 remove-field-btn"
                                onclick="removeField(this)" th:text="#{button.remove}">Remove</button>
                        </div>
                        <div th:each="ing : ${recipe.ingredients}">
                            <div class="input-group mb-2">
                                <textarea name="ingredients" class="form-control" rows="2" th:text="${ing}"></textarea>
                                <button type="button" class="btn btn-outline-danger ms-2 remove-field-btn"
                                    onclick="removeField(this)" th:text="#{button.remove}">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addIngredient()" th:text="#{button.addIngredient}">Add
                        ingredient</button>
                </div>

                <div class="mb-3">
                    <label class="form-label" th:text="#{label.instructions}">Instructions</label>
                    <div id="instructionsContainer">
                        <div th:if="${#lists.isEmpty(recipe.instructions)}" class="input-group mb-2">
                            <textarea name="instructions" class="form-control" rows="3"
                                th:placeholder="#{placeholder.addStep}"></textarea>
                            <button type="button" class="btn btn-outline-danger ms-2 remove-field-btn"
                                onclick="removeField(this)" th:text="#{button.remove}">Remove</button>
                        </div>
                        <div th:each="ins : ${recipe.instructions}">
                            <div class="input-group mb-2">
                                <textarea name="instructions" class="form-control" rows="3" th:text="${ins}"></textarea>
                                <button type="button" class="btn btn-outline-danger ms-2 remove-field-btn"
                                    onclick="removeField(this)" th:text="#{button.remove}">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addInstruction()" th:text="#{button.addStep}">Add
                        step</button>
                </div>
                <div class="mb-3">
                    <label for="story" class="form-label" th:text="#{label.story}">Story</label>
                    <textarea id="story" name="story" class="form-control" rows="3"
                        th:text="${recipe.story}"></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" th:text="#{button.saveChanges}">Save Changes</button>

                    <!-- The Cancel button returns to the previous page if it is from the same site, otherwise goes to the recipe view page -->
                    <a class="btn btn-secondary" th:href="@{/recipes/{id}(id=${recipe.recipeId})}" th:text="#{button.cancel}"
                        onclick="if (document.referrer && document.referrer.startsWith(window.location.origin)) { window.location = document.referrer; return false; }">Cancel</a>
                    
                        <form th:action="@{/recipes/{id}/delete(id=${recipe.recipeId})}" method="post" th:attr="data-confirm=#{confirm.deleteRecipe}"
                        onsubmit="return confirm(this.dataset.confirm)" style="display:inline; margin-top:8px;">
                        <button class="btn btn-danger" type="submit" th:text="#{button.delete}">Delete</button>
                    </form>
                </div>
            </form>
        </div>
    </main>
    <div th:replace="fragments :: footer"></div>

    <script>
        function updateRemoveButtons() {
            ['ingredientsContainer', 'instructionsContainer'].forEach(id => {
                const container = document.getElementById(id);
                if (!container) return;
                const groups = container.querySelectorAll('.input-group');
                const buttons = container.querySelectorAll('.remove-field-btn');
                if (groups.length <= 1) {
                    buttons.forEach(b => b.style.display = 'none');
                } else {
                    buttons.forEach(b => b.style.display = '');
                }
            });
        }

        function addIngredient(value) {
            const removeText = document.body.dataset.removeText || 'Remove';
            const addIngredientPlaceholder = document.body.dataset.addIngredientText || 'One ingredient per field';

            const container = document.getElementById('ingredientsContainer');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';

            const ta = document.createElement('textarea');
            ta.name = 'ingredients';
            ta.className = 'form-control';
            ta.rows = 2;
            ta.placeholder = addIngredientPlaceholder;
            if (value) ta.value = value;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-danger ms-2 remove-field-btn';
            btn.textContent = removeText;
            btn.onclick = function () { removeField(btn); };

            div.appendChild(ta);
            div.appendChild(btn);
            container.appendChild(div);
            updateRemoveButtons();
        }

        function addInstruction(value) {
            const removeText = document.body.dataset.removeText || 'Remove';
            const addStepPlaceholder = document.body.dataset.addStepText || 'One step per field';

            const container = document.getElementById('instructionsContainer');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';

            const ta = document.createElement('textarea');
            ta.name = 'instructions';
            ta.className = 'form-control';
            ta.rows = 3;
            ta.placeholder = addStepPlaceholder;
            if (value) ta.value = value;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-danger ms-2 remove-field-btn';
            btn.textContent = removeText;
            btn.onclick = function () { removeField(btn); };

            div.appendChild(ta);
            div.appendChild(btn);
            container.appendChild(div);
            updateRemoveButtons();
        }

        function removeField(btn) {
            const group = btn.closest('.input-group');
            if (group) group.remove();
            updateRemoveButtons();
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateRemoveButtons();
        });
    </script>

</body>

</html>